<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.anylogic.ssystem.bms.login.mapper.ComUserinfoMapper">


    <resultMap id="getUserLoginMap" type="com.anylogic.ssystem.bms.login.model.GetUserLoginResVO">
        <id column="userid" property="userid" />                      <!--  -->
        <result column="loginid" property="loginid" />                <!--  -->
        <result column="username" property="username" />              <!--  -->
        <result column="deptid" property="deptid" />                  <!--  -->
        <result column="deptname" property="deptname" />              <!--  -->
        <result column="residentno" property="residentno" />          <!--  -->
        <result column="position" property="position" />              <!-- 직급 -->
        <result column="grade" property="grade" />                    <!-- 직위 -->
        <result column="userorder" property="userorder" />            <!--  -->
        <result column="imgubun" property="imgubun" />                <!--  -->
        <result column="isdeleted" property="isdeleted" />            <!--  -->
        <result column="isconcurrent" property="isconcurrent" />      <!--  -->
        <result column="positiondetail" property="positiondetail" />  <!--  -->
        <result column="vgroupid" property="vgroupid" />                      <!--  -->
        <result column="orgname" property="orgname" />
        <result column="parentorgid" property="parentorgid" />
        <result column="absenceyn" property="absenceyn" />
        <result column="absenceid" property="absenceid" />
        <result column="absencedt" property="absencedt" />
    </resultMap>



    <!--   - getUserLogin -->
    <select id="getUserLogin" parameterType="com.anylogic.ssystem.bms.login.model.GetUserLoginReqVO" resultMap="getUserLoginMap">

        SELECT
            A.userid as "userid"
            , A.loginid as "loginid"
            , A.username as "username"
            , A.deptid as "deptid"
            , A.deptname as "deptname"
            , A.residentno as "residentno"
            , A.position as "position"
            , A.grade as "grade"
            , A.userorder as "userorder"
            , A.imgubun as "imgubun"
            , A.isdeleted as "isdeleted"
            , A.isconcurrent as "isconcurrent"
            , A.positiondetail as "positiondetail"
            , A.absenceyn as "absenceyn"
            , A.absenceid as "absenceid"
            , A.absencedt as "absencedt"
            , coalesce(string_agg(B.vgroupid, ', '), '') as "vgroupid"
            , C.orgname as "orgname"
            , C.parentorgid as "parentorgid"
        FROM  sbms.sbms_user.com_userinfo A
        LEFT OUTER JOIN sbms.sbms_user.com_vgroup_user B
        ON (A.userid = B.userid)
        INNER JOIN sbms.sbms_user.com_organizationinfo C
        ON (A.deptid = C.orgid)
        WHERE 1 = 1
          and A.userid =  #{userid}
        GROUP by A.userid, C.orgname, C.parentorgid

    </select>


    <!-- updateAbsence -->
    <update id="updateAbsence" parameterType="com.anylogic.ssystem.bms.login.model.UpdateAbsenceReqVO">
        UPDATE sbms.sbms_user.com_userinfo
        SET
            absenceyn = #{absenceyn},
            absenceid = #{absenceid},
            absencedt = REPLACE(#{absencedt},'-','')
        WHERE userid = #{userid}
    </update>

</mapper>
